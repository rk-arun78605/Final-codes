 WITH priority_shops AS (
         SELECT t.shop_code,
            t.priority_rank
           FROM ( VALUES ('SPN'::text,1), ('MSS'::text,2), ('LFS'::text,3), ('M03'::text,4), ('KAS'::text,5), ('MM1'::text,6), ('MM2'::text,7), ('FAR'::text,8), ('KS7'::text,9), ('WHL'::text,10), ('MM3'::text,11)) t(shop_code, priority_rank)
        ), item_wh_grn AS (
         SELECT TRIM(BOTH FROM upper(sup_shop_grn.item_code)) AS item_code,
            max(sup_shop_grn.wh_grn_date) AS wh_grn_date,
            (max(sup_shop_grn.wh_grn_date) + '30 days'::interval) AS wh_grn_plus_30
           FROM sup_shop_grn
          WHERE (sup_shop_grn.wh_grn_date IS NOT NULL)
          GROUP BY (TRIM(BOTH FROM upper(sup_shop_grn.item_code)))
        ), shop_expiry_latest AS (
         SELECT TRIM(BOTH FROM upper(shopexpiry."ITEM_CODE")) AS item_code,
            TRIM(BOTH FROM upper(shopexpiry."SHOP_CODE")) AS shop_code,
            max(shopexpiry."SHOP_EXPIRY_DATE") AS latest_expiry_date
           FROM shopexpiry
          GROUP BY (TRIM(BOTH FROM upper(shopexpiry."ITEM_CODE"))), (TRIM(BOTH FROM upper(shopexpiry."SHOP_CODE")))
        ), sources AS (
         SELECT im.itemcode AS item_code,
            im.itemname AS item_name,
            im.shopcode AS shop_code,
            im.shopstock AS stock,
            COALESCE(im.sales_30d_wh, (0)::numeric) AS sales_30d,
            im.shopgrn_dt AS last_grn_date,
                CASE
                    WHEN (im.shopgrn_dt IS NOT NULL) THEN (CURRENT_DATE - (im.shopgrn_dt)::date)
                    ELSE 0
                END AS grn_age,
            wh.wh_grn_date,
            im.groupp AS groups,
            im.subgroup AS sub_group,
            se.latest_expiry_date AS source_expiry_date,
                CASE
                    WHEN (se.latest_expiry_date IS NOT NULL) THEN ((se.latest_expiry_date)::date - CURRENT_DATE)
                    ELSE NULL::integer
                END AS source_expiry_days,
                CASE
                    WHEN (se.latest_expiry_date IS NULL) THEN NULL::text
                    WHEN (EXTRACT(year FROM (se.latest_expiry_date)::date) > (EXTRACT(year FROM CURRENT_DATE) + (2)::numeric)) THEN 'Check expiry date'::text
                    ELSE NULL::text
                END AS expiry_check,
            im.importexport AS item_type,
            im.suppliername AS supplier_name
           FROM ((inventory_master im
             LEFT JOIN item_wh_grn wh ON ((TRIM(BOTH FROM upper(im.itemcode)) = wh.item_code)))
             LEFT JOIN shop_expiry_latest se ON (((TRIM(BOTH FROM upper(im.itemcode)) = se.item_code) AND (TRIM(BOTH FROM upper(im.shopcode)) = se.shop_code))))
          WHERE ((NOT (im.shopcode IN ( SELECT priority_shops.shop_code
                   FROM priority_shops))) AND (im.shopstock > COALESCE(im.sales_30d_wh, (0)::numeric)) AND (im.shopstock > (0)::numeric))
        ), destinations AS (
         SELECT im.itemcode AS item_code,
            im.shopcode AS shop_code,
            im.shopstock AS stock,
            COALESCE(im.sales_30d_wh, (0)::numeric) AS sales_30d,
            im.shopgrn_dt AS last_grn_date,
                CASE
                    WHEN (im.shopgrn_dt IS NOT NULL) THEN (CURRENT_DATE - (im.shopgrn_dt)::date)
                    ELSE 0
                END AS grn_age,
            wh.wh_grn_date,
            wh.wh_grn_plus_30,
            ps.priority_rank
           FROM ((inventory_master im
             JOIN priority_shops ps ON ((im.shopcode = ps.shop_code)))
             LEFT JOIN item_wh_grn wh ON ((TRIM(BOTH FROM upper(im.itemcode)) = wh.item_code)))
          WHERE (im.itemcode IS NOT NULL)
        ), dest_wh_grn_sales AS (
         SELECT d.item_code,
            d.shop_code,
            COALESCE(sum(s."QTY"), (0)::double precision) AS wh_grn_30d_sales
           FROM (destinations d
             LEFT JOIN sales_2024 s ON (((TRIM(BOTH FROM upper(s."ITEM_CODE")) = d.item_code) AND (TRIM(BOTH FROM upper(s."SHOP_CODE")) = d.shop_code) AND ((s."DATE_INVOICE")::date >= (d.wh_grn_date)::date) AND ((s."DATE_INVOICE")::date <= (d.wh_grn_plus_30)::date))))
          WHERE (d.wh_grn_date IS NOT NULL)
          GROUP BY d.item_code, d.shop_code
        UNION ALL
         SELECT d.item_code,
            d.shop_code,
            COALESCE(sum(s."QTY"), (0)::numeric) AS wh_grn_30d_sales
           FROM (destinations d
             LEFT JOIN sales_2025 s ON (((TRIM(BOTH FROM upper(s."ITEM_CODE")) = d.item_code) AND (TRIM(BOTH FROM upper(s."SHOP_CODE")) = d.shop_code) AND ((s."DATE_INVOICE")::date >= (d.wh_grn_date)::date) AND ((s."DATE_INVOICE")::date <= (d.wh_grn_plus_30)::date))))
          WHERE (d.wh_grn_date IS NOT NULL)
          GROUP BY d.item_code, d.shop_code
        ), dest_wh_grn_sales_agg AS (
         SELECT dest_wh_grn_sales.item_code,
            dest_wh_grn_sales.shop_code,
            sum(dest_wh_grn_sales.wh_grn_30d_sales) AS wh_grn_30d_sales
           FROM dest_wh_grn_sales
          GROUP BY dest_wh_grn_sales.item_code, dest_wh_grn_sales.shop_code
        ), dest_capacity AS (
         SELECT d.item_code,
            d.shop_code,
            d.stock,
            d.sales_30d,
            d.last_grn_date,
            d.grn_age,
            d.wh_grn_date,
            d.wh_grn_plus_30,
            d.priority_rank,
            COALESCE(wh.wh_grn_30d_sales, (0)::double precision) AS wh_grn_30d_sales,
            GREATEST(COALESCE(wh.wh_grn_30d_sales, (0)::double precision), (d.sales_30d)::double precision) AS cap
           FROM (destinations d
             LEFT JOIN dest_wh_grn_sales_agg wh ON (((d.item_code = wh.item_code) AND (d.shop_code = wh.shop_code))))
        ), all_combinations AS (
         SELECT s.item_code,
            s.item_name,
            s.shop_code AS source_shop,
            s.stock AS source_stock,
            s.sales_30d AS source_sales,
            s.last_grn_date AS source_last_grn,
            s.grn_age AS source_grn_age,
            s.wh_grn_date AS source_wh_grn_date,
            s.source_expiry_date,
            s.source_expiry_days,
            s.expiry_check,
            s.groups,
            s.sub_group,
            s.item_type,
            s.supplier_name,
            d.shop_code AS dest_shop,
            d.stock AS dest_stock,
            d.sales_30d AS dest_sales,
            d.last_grn_date AS dest_last_grn,
            d.grn_age AS dest_grn_age,
            d.wh_grn_date AS dest_wh_grn_date,
            d.wh_grn_plus_30 AS dest_wh_grn_plus_30,
            d.wh_grn_30d_sales AS dest_wh_grn_30d_sales,
            d.cap AS dest_cap,
            d.priority_rank
           FROM (sources s
             JOIN dest_capacity d ON ((s.item_code = d.item_code)))
          WHERE (s.shop_code <> d.shop_code)
        ), uncapped_recs AS (
         SELECT all_combinations.item_code,
            all_combinations.item_name,
            all_combinations.source_shop,
            all_combinations.source_stock,
            all_combinations.source_sales,
            all_combinations.source_last_grn,
            all_combinations.source_grn_age,
            all_combinations.source_wh_grn_date,
            all_combinations.source_expiry_date,
            all_combinations.source_expiry_days,
            all_combinations.expiry_check,
            all_combinations.groups,
            all_combinations.sub_group,
            all_combinations.item_type,
            all_combinations.supplier_name,
            all_combinations.dest_shop,
            all_combinations.dest_stock,
            all_combinations.dest_sales,
            all_combinations.dest_last_grn,
            all_combinations.dest_grn_age,
            all_combinations.dest_wh_grn_date,
            all_combinations.dest_wh_grn_plus_30,
            all_combinations.dest_wh_grn_30d_sales,
            all_combinations.dest_cap,
            all_combinations.priority_rank,
            GREATEST((all_combinations.dest_cap - (all_combinations.dest_stock)::double precision), (0)::double precision) AS dest_gap,
            GREATEST((all_combinations.source_stock - all_combinations.source_sales), (0)::numeric) AS source_available,
            LEAST(GREATEST((all_combinations.dest_cap - (all_combinations.dest_stock)::double precision), (0)::double precision), (GREATEST((all_combinations.source_stock - all_combinations.source_sales), (0)::numeric))::double precision) AS uncapped_qty
           FROM all_combinations
          WHERE ((all_combinations.source_stock > all_combinations.source_sales) AND (NOT ((all_combinations.source_sales = (0)::numeric) AND (all_combinations.dest_sales = (0)::numeric) AND (all_combinations.dest_wh_grn_30d_sales = (0)::double precision))) AND (NOT ((all_combinations.dest_stock > (30)::numeric) AND ((all_combinations.dest_stock)::double precision < LEAST((all_combinations.dest_sales)::double precision, all_combinations.dest_wh_grn_30d_sales)))))
        ), capped_recs AS (
         SELECT uncapped_recs.item_code,
            uncapped_recs.item_name,
            uncapped_recs.source_shop,
            uncapped_recs.source_stock,
            uncapped_recs.source_sales,
            uncapped_recs.source_last_grn,
            uncapped_recs.source_grn_age,
            uncapped_recs.source_wh_grn_date,
            uncapped_recs.source_expiry_date,
            uncapped_recs.source_expiry_days,
            uncapped_recs.expiry_check,
            uncapped_recs.groups,
            uncapped_recs.sub_group,
            uncapped_recs.item_type,
            uncapped_recs.supplier_name,
            uncapped_recs.dest_shop,
            uncapped_recs.dest_stock,
            uncapped_recs.dest_sales,
            uncapped_recs.dest_last_grn,
            uncapped_recs.dest_grn_age,
            uncapped_recs.dest_wh_grn_date,
            uncapped_recs.dest_wh_grn_plus_30,
            uncapped_recs.dest_wh_grn_30d_sales,
            uncapped_recs.dest_cap,
            uncapped_recs.priority_rank,
            uncapped_recs.uncapped_qty,
            uncapped_recs.source_available,
                CASE
                    WHEN (uncapped_recs.source_expiry_date IS NULL) THEN 'OK'::text
                    WHEN (uncapped_recs.source_expiry_days < 0) THEN 'Expired'::text
                    WHEN ((uncapped_recs.source_expiry_days >= 1) AND (uncapped_recs.source_expiry_days <= 29)) THEN 'Expiring'::text
                    WHEN (uncapped_recs.source_expiry_days >= 30) THEN 'OK'::text
                    ELSE 'OK'::text
                END AS expiry_status,
            sum(
                CASE
                    WHEN (uncapped_recs.source_expiry_date IS NULL) THEN uncapped_recs.uncapped_qty
                    WHEN (uncapped_recs.source_expiry_days < 30) THEN (0)::double precision
                    WHEN (uncapped_recs.source_expiry_days >= 30) THEN uncapped_recs.uncapped_qty
                    ELSE (0)::double precision
                END) OVER (PARTITION BY uncapped_recs.item_code, uncapped_recs.dest_shop ORDER BY uncapped_recs.priority_rank, uncapped_recs.source_grn_age DESC, COALESCE(uncapped_recs.source_expiry_days, 999999), uncapped_recs.source_stock DESC, uncapped_recs.source_shop ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) AS cumulative_before_this_row,
                CASE
                    WHEN ((uncapped_recs.source_expiry_date IS NOT NULL) AND (uncapped_recs.source_expiry_days < 30)) THEN (0)::double precision
                    ELSE LEAST(uncapped_recs.uncapped_qty, GREATEST((uncapped_recs.dest_cap - COALESCE(sum(
                    CASE
                        WHEN (uncapped_recs.source_expiry_date IS NULL) THEN uncapped_recs.uncapped_qty
                        WHEN (uncapped_recs.source_expiry_days < 30) THEN (0)::double precision
                        WHEN (uncapped_recs.source_expiry_days >= 30) THEN uncapped_recs.uncapped_qty
                        ELSE (0)::double precision
                    END) OVER (PARTITION BY uncapped_recs.item_code, uncapped_recs.dest_shop ORDER BY uncapped_recs.priority_rank, uncapped_recs.source_grn_age DESC, COALESCE(uncapped_recs.source_expiry_days, 999999), uncapped_recs.source_stock DESC, uncapped_recs.source_shop ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING), (0)::double precision)), (0)::double precision))
                END AS recommended_qty
           FROM uncapped_recs
        ), source_allocation_check AS (
         SELECT capped_recs.item_code,
            capped_recs.item_name,
            capped_recs.source_shop,
            capped_recs.source_stock,
            capped_recs.source_sales,
            capped_recs.source_last_grn,
            capped_recs.source_grn_age,
            capped_recs.source_wh_grn_date,
            capped_recs.source_expiry_date,
            capped_recs.source_expiry_days,
            capped_recs.expiry_check,
            capped_recs.groups,
            capped_recs.sub_group,
            capped_recs.item_type,
            capped_recs.supplier_name,
            capped_recs.dest_shop,
            capped_recs.dest_stock,
            capped_recs.dest_sales,
            capped_recs.dest_last_grn,
            capped_recs.dest_grn_age,
            capped_recs.dest_wh_grn_date,
            capped_recs.dest_wh_grn_plus_30,
            capped_recs.dest_wh_grn_30d_sales,
            capped_recs.dest_cap,
            capped_recs.priority_rank,
            capped_recs.uncapped_qty,
            capped_recs.source_available,
            capped_recs.expiry_status,
            capped_recs.cumulative_before_this_row,
            capped_recs.recommended_qty,
            sum(capped_recs.recommended_qty) OVER (PARTITION BY capped_recs.item_code, capped_recs.source_shop ORDER BY capped_recs.priority_rank, capped_recs.source_grn_age DESC, COALESCE(capped_recs.source_expiry_days, 999999), capped_recs.source_stock DESC, capped_recs.dest_shop) AS cumulative_source_allocated
           FROM capped_recs
        ), final_results AS (
         SELECT source_allocation_check.item_code,
            source_allocation_check.item_name,
            source_allocation_check.groups,
            source_allocation_check.sub_group,
            source_allocation_check.item_type,
            source_allocation_check.supplier_name,
            source_allocation_check.source_shop,
            source_allocation_check.source_stock,
            source_allocation_check.source_sales,
            source_allocation_check.source_last_grn,
            source_allocation_check.source_grn_age,
            source_allocation_check.source_wh_grn_date,
            source_allocation_check.source_expiry_date,
            source_allocation_check.source_expiry_days,
            source_allocation_check.expiry_check,
            source_allocation_check.expiry_status,
            source_allocation_check.dest_shop,
            source_allocation_check.dest_stock,
            source_allocation_check.dest_sales,
            source_allocation_check.dest_last_grn,
            source_allocation_check.dest_grn_age,
            source_allocation_check.dest_wh_grn_date,
            source_allocation_check.dest_wh_grn_plus_30,
            source_allocation_check.dest_wh_grn_30d_sales,
            source_allocation_check.dest_cap AS dest_sales_used,
            source_allocation_check.priority_rank,
            source_allocation_check.recommended_qty,
            sum(source_allocation_check.recommended_qty) OVER (PARTITION BY source_allocation_check.item_code, source_allocation_check.dest_shop ORDER BY source_allocation_check.priority_rank, source_allocation_check.source_grn_age DESC, COALESCE(source_allocation_check.source_expiry_days, 999999), source_allocation_check.source_stock DESC, source_allocation_check.source_shop) AS cumulative_qty,
            (source_allocation_check.dest_cap - COALESCE(sum(source_allocation_check.recommended_qty) OVER (PARTITION BY source_allocation_check.item_code, source_allocation_check.dest_shop ORDER BY source_allocation_check.priority_rank, source_allocation_check.source_grn_age DESC, COALESCE(source_allocation_check.source_expiry_days, 999999), source_allocation_check.source_stock DESC, source_allocation_check.source_shop ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING), (0)::double precision)) AS dest_remaining_cap_before,
            ((source_allocation_check.dest_stock)::double precision + source_allocation_check.recommended_qty) AS dest_updated_stock,
                CASE
                    WHEN ((((source_allocation_check.dest_stock)::double precision + source_allocation_check.recommended_qty) > (0)::double precision) AND (GREATEST(source_allocation_check.dest_wh_grn_30d_sales, (source_allocation_check.dest_sales)::double precision) > (0)::double precision)) THEN ceil(((((source_allocation_check.dest_stock)::double precision + source_allocation_check.recommended_qty) * (30.0)::double precision) / GREATEST(source_allocation_check.dest_wh_grn_30d_sales, (source_allocation_check.dest_sales)::double precision)))
                    WHEN (((source_allocation_check.dest_stock)::double precision + source_allocation_check.recommended_qty) > (0)::double precision) THEN (999)::double precision
                    ELSE (0)::double precision
                END AS dest_final_stock_days,
                CASE
                    WHEN (source_allocation_check.expiry_status = 'Expired'::text) THEN 'Item expired - cannot transfer'::text
                    WHEN ((source_allocation_check.expiry_status = 'Expiring'::text) AND (source_allocation_check.source_expiry_days < 30)) THEN 'Expiring soon - cannot transfer'::text
                    WHEN (source_allocation_check.cumulative_source_allocated >= (source_allocation_check.source_available)::double precision) THEN 'Source stock fully allocated'::text
                    WHEN ((source_allocation_check.recommended_qty = (0)::double precision) AND (source_allocation_check.uncapped_qty > (0)::double precision)) THEN 'Cap reached'::text
                    WHEN ((source_allocation_check.recommended_qty > (0)::double precision) AND (source_allocation_check.recommended_qty < source_allocation_check.uncapped_qty)) THEN 'Partial allocation'::text
                    WHEN (source_allocation_check.recommended_qty > (0)::double precision) THEN 'Full allocation'::text
                    ELSE 'No transfer needed'::text
                END AS remark
           FROM source_allocation_check
        )
 SELECT item_code,
    item_name,
    groups,
    sub_group,
    item_type,
    supplier_name,
    source_shop,
    source_stock,
    source_sales,
    source_last_grn,
    source_grn_age,
    source_wh_grn_date,
    source_expiry_date,
    source_expiry_days,
    expiry_check,
    expiry_status,
    dest_shop,
    dest_stock,
    dest_sales,
    dest_last_grn,
    dest_grn_age,
    dest_wh_grn_date,
    dest_wh_grn_plus_30,
    dest_wh_grn_30d_sales,
    dest_sales_used,
    priority_rank,
    recommended_qty,
    cumulative_qty,
    dest_remaining_cap_before,
    dest_updated_stock,
    dest_final_stock_days,
    remark
   FROM final_results
  ORDER BY item_code, dest_shop, priority_rank, source_grn_age DESC, COALESCE(source_expiry_days, 999999), source_stock DESC, source_shop;
